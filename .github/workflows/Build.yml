name: Rust-Autumn-Release

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build-release:
    name: 3OS-Release-Build
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

        # Install Rust
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

        # Build
      - name: Build
        run: cargo build --release

      - name: Prepare proofledger
        run: mkdir -p proofledger

      # SHA256 for Linux/macOS
      - name: Generate SHA256 (Unix)
        if: runner.os != 'Windows'
        run: |
          OS_LOWER=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          FILE="proofledger/sha256-$OS_LOWER.txt"
          echo "=== SHA256 Summary ($OS_LOWER) ===" > $FILE
          find target/release -maxdepth 1 -type f -print0 | xargs -0 sha256sum >> $FILE

      # SHA256 for Windows
      - name: Generate SHA256 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $FILE = "proofledger/sha256-windows.txt"
          "=== SHA256 Summary (windows) ===" | Out-File -FilePath $FILE -Encoding utf8
          Get-ChildItem "target/release" -File | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$hash  $($_.Name)" | Out-File -FilePath $FILE -Encoding utf8 -Append
          }

      # Zip per OS
      - name: Zip artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          OS_LOWER=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          zip -r autumn-$OS_LOWER.zip target/release/* proofledger/*

      - name: Zip artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target/release/*","proofledger/*" -DestinationPath "autumn-windows.zip" -Force

      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: autumn-${{ runner.os }}
          path: |
            *.zip
            proofledger/*.txt

  release:
    name: Create Release
    needs: build-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Tag
        id: tagstep
        run: |
          TAG="v1.0.$(date +'%Y%m%d%H%M')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag $TAG
          git push origin $TAG

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagstep.outputs.tag }}
          name: "Autumn Release ${{ steps.tagstep.outputs.tag }}"
          draft: false
          prerelease: false
          files: |
            release_files/**/*.zip
            release_files/**/*.txt
